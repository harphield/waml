<?phprequire_once 'db.php';@require_once 'security.php';if ($isadmin) { //handling creation and alteration of leagues/seasons  if (isset($_POST['type'])) {    if ($_POST['type'] == 'seasonupdate') {      $type[0]='season';$type[1]='update';    } elseif ($_POST['type'] == 'seasonnew') {      $type[0]='season';$type[1]='new';      echo 'lets create a new season';    } elseif ($_POST['type'] == 'leaguenew') {       $type[0]='league';$type[1]='new';    } elseif ($_POST['type'] == 'leagueupdate') {       $type[0]='league';$type[1]='update';    } elseif ($_POST['type'] == 'massadd') {       $type = 'massadd';    } elseif ($_POST['type'] == 'emptyleague') {       $type = 'emptyleague';    } else { echo "Something is wrong<BR>"; return;}    if($type == 'emptyleague') {      if (isset($_POST['lid'])) {	$lid = $_POST['lid'];	if (!is_numeric($lid)) {echo 'error1';return;}	$stmt = $dbh->prepare("DELETE from yseasongames WHERE (sid,gid) in (SELECT sid,gid from ygames_players  natural join yseasonplayers natural join yseasongames natural join yleagues where lid=:lid)");	$stmt->bindParam(':lid', $lid);	$stmt->execute();	echo $stmt->rowCount() . ' deleted games (will be readded by cron)<BR>';	$stmt = $dbh->prepare("DELETE from yseasonplayers WHERE lid=:lid");	$stmt->bindParam(':lid', $lid);	$stmt->execute();	echo $stmt->rowCount() . ' deleted players<BR>';	$stmt = $dbh->prepare("DELETE from yseasonscore WHERE lid=:lid");	$stmt->bindParam(':lid', $lid);	$stmt->execute();	echo $stmt->rowCount() . ' deleted scores, trust the cron<BR>';// we must update values!//made the easiest sollution, just remove the games, and cron will readd them//when noticing timeoverlap and readd the players to appropriate defaultleague      } else echo "emptyleague failed";    } elseif($type == 'massadd') {      if (isset($_POST['tolid']) && isset($_POST['fromlid'])) {	$tolid = $_POST['tolid'];	$fromlid = $_POST['fromlid'];	if (isset($_POST['asc'])) $asc = $_POST['asc'];	if (isset($_POST['desc'])) $desc = $_POST['desc'];	if (isset($_POST['limit'])) $limit = $_POST['limit'];	if (isset($_POST['offset'])) {	  $offset = $_POST['offset'];	  if (isset($_POST['offsetvalue']) && $offset) $offsetvalue = $_POST['offsetvalue'];	}	if (isset($_POST['games'])) {	  $games = $_POST['games'];	  if (isset($_POST['gamesamount']) && $games) $gamesamount = $_POST['gamesamount'];	}	if ($asc==$desc) {echo 'Cannot sort bort ASC and DESC or neither, abort<BR>'; return;}	$command = "INSERT INTO yseasonplayers (lid,pid) (SELECT :tolid, pid FROM yseasonscore WHERE lid=:fromlid";	if($games) $command .= " AND scgames >=:games";	$command .= " ORDER BY scpoints";	if($asc) $command .= " ASC";	if($desc) $command .= " DESC";	if($limit) $command .= " LIMIT :limit";	if($offset) $command .= " OFFSET :offsetvalue";	$command .= ")";//INSERT into yseasonplayers (lid,pid) (select 4,pid from yseasonscore natural join yplayers where lid=1 and scgames >=20 ORDER BY scpoints DESC LIMIT 70-31 OFFSET 31);//	echo $command;	$stmt = $dbh->prepare($command);	$stmt->bindParam(':tolid', $tolid);	$stmt->bindParam(':fromlid', $fromlid);	if($games) $stmt->bindParam(':games', $gamesamount);	if($limit) $stmt->bindParam(':limit', $limit);	if($offset) $stmt->bindParam(':offsetvalue', $offsetvalue);	$stmt->execute();	echo $stmt->rowCount() . ' added players<BR>Suggestion: empty the default league to remove potential dublicates<BR>';// nothing that needs to be done, cron will handle the rest      } else echo "massadd failed";    }     elseif($type[0]=='season') {      $i=0;      if (isset($_POST['sname'])) $sname = $_POST['sname'];      if (isset($_POST['sshort'])) $sshort = $_POST['sshort'];      if (isset($_POST['defaultleague'])) $default = $_POST['defaultleague'];      if (isset($_POST['startdate'])) $startdate = $_POST['startdate'];      if (isset($_POST['enddate'])) $enddate = $_POST['enddate'];      if (isset($_POST['sid']) && $type[1]=='update') {	$sid = $_POST['sid'];	if (!is_numeric($sid)) {echo 'error1';return;}	$stmt = $dbh->prepare("SELECT sname,sshort,defaultleague,enddate-1 as enddate,startdate FROM yseasons where sid=:sid");	$stmt->bindParam(':sid', $sid);	$stmt->execute();	if ($stmt->rowCount() != 1) {echo 'error2';return;}	$data = $stmt->fetch();	$command = "UPDATE yseasons set ";	if ($sname != $data['sname']) {	  $command .= "sname=:sname "; $i++;	} else $sname = null;	if ($sshort != $data['sshort']) {	  $command .= (($i>0)? ",":'') . "sshort=:sshort "; $i++;	} else $sshort = null;	if ($default != $data['defaultleague']) {	  $command .= (($i>0)? ",":'') . "defaultleague=:default "; $i++;	} else $default = null;	if ($startdate != $data['startdate']) {	  $command .= (($i>0)? ",":'') . "startdate=:startdate "; $i++;	} else $startdate = null;	if ($enddate != $data['enddate']) {	  $command .= (($i>0)? ",":'') . "enddate=(:enddate::date)+1 "; $i++;	} else $enddate = null;	$command .= "where sid=:sid";	//echo $command;      } elseif ($type[1] == 'new') {	$command = "INSERT INTO yseasons (startdate,enddate,sname,sshort) VALUES (:startdate,(:enddate::date)+1,:sname,:sshort)";	$sid = null;	$default = null;	$i++;      } else {echo 'failed ' . $type[0] . ' ' . $type[1]; return;}      if ($i>0) {	$stmt = $dbh->prepare($command);	if(!is_null($sid)) $stmt->bindParam(':sid', $sid);	if(!is_null($enddate)) $stmt->bindParam(':enddate', $enddate);	if(!is_null($startdate)) $stmt->bindParam(':startdate', $startdate);	if(!is_null($sshort)) $stmt->bindParam(':sshort', $sshort);	if(!is_null($default)) $stmt->bindParam(':default', $default);	if(!is_null($sname)) $stmt->bindParam(':sname', $sname);	$stmt->execute();	if ($stmt->rowCount() != 1) {	  echo 'error ' . $command;return;	} else {	  echo 'success<BR>';  // we should remove some games from yseasongames, if date has been shortened  // also, if successful, we should recalc all players who are affected// let's just remove the scores and let cron recalc them	$stmt = $dbh->prepare("DELETE FROM yseasonscore WHERE (lid,pid) IN (SELECT (lid,pid) from yseasongames NATURAL JOIN yseasonplayers natural join yleagues NATURAL JOIN ygames_players WHERE (sid,gid) not in (SELECT sid,gid FROM ygames, yseasons WHERE (startdate,enddate) OVERLAPS (gametime,gametime)))");	$stmt->execute();	echo $stmt->rowCount() . ' deleted scores (will be readded by cron)<BR>';	$stmt = $dbh->prepare("DELETE from yseasongames WHERE (sid,gid) not in (SELECT sid,gid FROM ygames, yseasons WHERE (startdate,enddate) OVERLAPS (gametime,gametime))");	$stmt->execute();	echo $stmt->rowCount() . ' deleted games<BR>';	}      } else echo 'nothing to change<BR>';    }    elseif ($type[0] == 'league') {      $i=0;      if (isset($_POST['lname'])) $lname = $_POST['lname'];      if (isset($_POST['lshort'])) $lshort = $_POST['lshort'];      if (isset($_POST['sid'])) $sid = $_POST['sid'];      if (isset($_POST['padding'])) $padding = $_POST['padding'];      if (isset($_POST['coef'])) $coef = $_POST['coef'];      if (isset($_POST['lid']) && $type[1]=='update') {	$lid = $_POST['lid'];	if (!is_numeric($lid)) {echo 'error1';return;}	$stmt = $dbh->prepare("SELECT lname,lshort,sid,padding,coef FROM yleagues WHERE lid=:lid");	$stmt->bindParam(':lid', $lid);	$stmt->execute();	if ($stmt->rowCount() != 1) {echo 'error2';return;}	$data = $stmt->fetch();	$command = "UPDATE yleagues set ";	if ($lname != $data['lname']) {	  $command .= "lname=:lname "; $i++;	} else $lname = null;	if ($lshort != $data['lshort']) {	  $command .= (($i>0)? ",":'') . "lshort=:lshort "; $i++;	} else $lshort = null;	if ($sid != $data['sid']) {	  $command .= (($i>0)? ",":'') . "sid=:sid "; $i++;	} else $sid = null;	if ($padding != $data['padding']) {	  $command .= (($i>0)? ",":'') . "padding=:padding "; $i++;	} else $padding = null;	if ($coef != $data['coef']) {	  $command .= (($i>0)? ",":'') . "coef=:coef "; $i++;	} else $coef = null;	$command .= "where lid=:lid";	echo $command;      } elseif ($type[1] == 'new') {	$command = "INSERT INTO yleagues (sid,lname,lshort,padding,coef) VALUES (:sid,:lname,:lshort,:padding,:coef)";	$lid = null;	$i++;      }       if ($i>0) {	$stmt = $dbh->prepare($command);	if(!is_null($lid)) $stmt->bindParam(':lid', $lid);	if(!is_null($lname)) $stmt->bindParam(':lname', $lname);	if(!is_null($lshort)) $stmt->bindParam(':lshort', $lshort);	if(!is_null($padding)) $stmt->bindParam(':padding', $padding);	if(!is_null($coef)) $stmt->bindParam(':coef', $coef);	if(!is_null($sid)) $stmt->bindParam(':sid', $sid);	$stmt->execute();	if ($stmt->rowCount() != 1) {	  echo 'error ' . $command;return;	} else {	  echo 'success<BR>';	  if(!is_null($lid)) {	    $stmt = $dbh->prepare("UPDATE yseasongames AS y SET value=joint.value,updated=now() FROM SELECT sid,gid,sum(coef)-sum(banned::int)*.2 AS value FROM yleagues NATURAL JOIN yseasonplayers NATURAL JOIN ygames_players NATURAL JOIN yseasongames WHERE (sid,gid) in (SELECT sid,gid from ygames_players  natural join yseasonplayers natural join yseasongames natural join yleagues where lid=:lid) GROUP BY sid,gid) AS joint WHERE y.sid=joint.sid AND y.gid=joint.gid");	    $stmt->bindParam(':lid', $lid);	    echo $stmt->rowCount() . ' recalced gamevalues<BR>';	  }// we should recalc value of games if coeff has changed, score if padding has changed// score will be automatically recalced by cron as we change the value of games// this is ofc not needed if league is new (and has no players)	}      } else echo 'nothing to change<BR>';    }  }}$stmt = $dbh->prepare("SELECT sshort, sname, lshort, lname, startdate, enddate-1 as enddate, sid, lid, padding, coef, defaultleague AS default FROM yleagues NATURAL FULL JOIN yseasons ORDER by lname");$stmt->execute();if ($stmt->rowCount() > 0) {	$leagues = $stmt->fetchAll();}$sid=0; //this is for detecting new seasonsif ($isadmin) {?>  <script type="text/javascript">    $(function() {<?php foreach ($leagues as $league) {   if($sid != $league['sid']) { $sid = $league['sid']; ?>      $('#season<?php echo $league['sid'];?>').change(function() {	if ($(this).is(':checked')) {//    $('.checkbox').not('#league1').hide(); <-why not work :(	  $('#txtSeason').show();//	  $('#txt1').value = 'helloe'; <- why not work?	  document.getElementById('sname').value = '<?php echo $league['sname']?>';	  document.getElementById('sshort').value = '<?php echo $league['sshort']?>';	  document.getElementById('startdate').value = '<?php echo $league['startdate']?>';	  document.getElementById('enddate').value = '<?php echo $league['enddate']?>';	  document.getElementById('defaultleague').value = '<?php echo $league['default']?>';	  document.getElementById('sid').value = '<?php echo $league['sid']?>';	  document.getElementById('stype').value = 'seasonupdate';	  document.getElementById('seasonsubmit').value = 'update';	} else {	  $('#txtSeason').hide();	}      });      $('#newleague<?php echo $league['sid'];?>').change(function() {	if ($(this).is(':checked')) {	  $('#txtLeague').show();	  document.getElementById('lname').value = '<?php echo $league['sname']?>';	  document.getElementById('lshort').value = '';	  document.getElementById('padding').value = '0';	  document.getElementById('coef').value = '0';	  document.getElementById('lid').value = '';	  document.getElementById('ltype').value = 'leaguenew';	  document.getElementById('lsname').value = '<?php echo $league['sname']?> (no change)';	  document.getElementById('lsid').value = '<?php echo $league['sid']?>';	  document.getElementById('leaguesubmit').value = 'create';	} else {	  $('#txtLeague').hide();	}      });<?php } ?>      $('#league<?php echo $league['lid'];?>').change(function() {	if ($(this).is(':checked')) {	  $('#txtLeague').show();	  document.getElementById('lname').value = '<?php echo $league['lname']?>';	  document.getElementById('lshort').value = '<?php echo $league['lshort']?>';	  document.getElementById('padding').value = '<?php echo $league['padding']?>';	  document.getElementById('coef').value = '<?php echo $league['coef']?>';	  document.getElementById('lid').value = '<?php echo $league['lid']?>';	  document.getElementById('lsname').value = '<?php echo $league['sname']?> (no change)';	  document.getElementById('lsid').value = '<?php echo $league['sid']?>';	  document.getElementById('ltype').value = 'leagueupdate';	  document.getElementById('leaguesubmit').value = 'update';	} else {	  $('#txtLeague').hide();	}      });<?php } ?>      $('#newseason').change(function() {	if ($(this).is(':checked')) {	  $('#txtSeason').show();	  document.getElementById('sname').value = 'xxx';	  document.getElementById('sshort').value = '';	  document.getElementById('startdate').value = 'YYYY-MM-DD';	  document.getElementById('enddate').value = 'YYYY-MM-DD';	  document.getElementById('defaultleague').value = '(this val will be ignored)';	  document.getElementById('sid').value = '';	  document.getElementById('stype').value = 'seasonnew';	  document.getElementById('seasonsubmit').value = 'create';	} else {	  $('#txtSeason').hide();	}      });      $('#massadd').change(function() {	if ($(this).is(':checked')) {	  $('#formmassadd').show();	} else {	  $('#formmassadd').hide();	}      });      $('#emptyleague').change(function() {	if ($(this).is(':checked')) {	  $('#formemptyleague').show();	} else {	  $('#formemptyleague').hide();	}      });    });  </script><?php } ?><table class="table table-striped table-condensed">  <thead><tr>    <th>League</th>    <th>Interval</th>    <th>Coef</th>    <th>Padding</th><?php if ($isadmin) {	?>    <th>Edit</th><?php } ?>  </tr></thead>  <tbody><?php foreach ($leagues as $league) {   if($sid != $league['sid']) { $sid = $league['sid']; ?>    <tr><td><span class="league l_<?php echo $league['sshort'];?>"><?php echo $league['sshort'];?></span>	<a href="index.php?p=s<?php echo $league['sid']?>"><?php echo $league['sname'];	    if ($isadmin) echo " (sid:" . $league['sid'] . ")";?></a></td>      <td><?php echo $league['startdate'] .'-'.$league['enddate'];?></td><?phpif ($isadmin) { ?>      <td colspan="2"><input type="checkbox" id="newleague<?php echo $league['sid']?>"> new League</td>      <td><div style="float: right;">	<label class="checkbox"><input type="checkbox" id="season<?php echo $league['sid'];?>"/>	</label>	</div></td><?php } else { ?>      <td></td><td></td><?php }} if (!is_null($league['lid'])) { ?>    <tr><td><span class="league l_<?php echo $league['sshort'];?>"><?php echo $league['sshort'];?></span><span class="league l_<?php echo $league['lshort'];?>"><?php echo $league['lshort'];?></span>	<a href="index.php?p=<?php echo $league['lid']+100?>"><?php echo $league['lname'];	    if ($isadmin) echo " (lid:" . $league['lid'] . ")";?></a></td>      <td><?php  if($league['lid'] == $league['default']) echo '(default)';?></td>      <td><?php echo $league['coef'];?></td>      <td><?php echo $league['padding'];?></td><?php if ($isadmin) {	?><td><div style="float: right;">	<label class="checkbox"><input type="checkbox" id="league<?php echo $league['lid'];?>" />	</label>	</div></td><?php } ?>    </tr><?php }} ?>  </tbody></table><?php if ($isadmin) {	?><div align="right"><input type="checkbox" id="emptyleague"> Empty League <input type="checkbox" id="massadd"> Mass Add to League <input type="checkbox" id="newseason"> Create new Season</div><div id="formemptyleague" hidden><form action="index.php?p=lg" method="post">  Empty league     <select name="lid"><?php foreach ($leagues as $league) { ?>      <option value="<?php echo $league['lid'] ?>"><?php echo $league['lname']?></option><?php } ?>    </select>    <input name="type" value="emptyleague" hidden>    <input type="submit" value="submit"></form></div><div id="formmassadd" hidden><form action="index.php?p=lg" method="post">  Mass add to     <select name="tolid"><?php foreach ($leagues as $league) { ?>      <option value="<?php echo $league['lid'] ?>"><?php echo $league['lname']?></option><?php } ?>    </select>  from     <select name="fromlid"><?php foreach ($leagues as $league) { ?>      <option value="<?php echo $league['lid'] ?>"><?php echo $league['lname']?></option><?php } ?>    </select> <BR>    <input type="checkbox" name="desc"> Top <input type="checkbox" name="asc"> Bottom <input type="text" name="limit" value="0">    <input type="checkbox" name="offset"> Offset <input type="text" name="offsetvalue" value="0"><BR>    <input type="checkbox" name="games"> Played games >= <input type="text" name="gamesamount" value="20"><BR>    <input name="type" value="massadd" hidden>    <input type="submit" value="submit"></form></div><div id="txtSeason" hidden><form action="index.php?p=lg" method="post"> SeasonName: <input type="text" id="sname" name="sname" value="" size="10" maxlenght="20"> Short <input type="text" id="sshort" name="sshort" value="" size="2" maxlenght="2"> <p><input type="date" id="startdate" name="startdate" value="" size="8" maxlenght="8"> to <input type="date" id="enddate" name="enddate" value="" size="8" maxlenght="8"> <p>Default leagueid: <input type="text" id="defaultleague" name="defaultleague" value="" size="2"><p> <input id="sid" name="sid" value="" hidden>  <input id="stype" name="type" value="season" hidden>  <input type="submit" id="seasonsubmit" value=""></form></div><div id="txtLeague" hidden><form action="index.php?p=lg" method="post"> League Name <input type="text" id="lname" name="lname" value="" size="10" maxlenght="20"> Short <input type="text" id="lshort" name="lshort" value="" size="2" maxlenght="2"> <p>Padding <input type="text" id="padding" name="padding" value="" size="8" maxlenght="8"> Coef <input type="text" id="coef" name="coef" value="" size="8" maxlenght="8"> Belongs to season  <input id="lsid" type="text" name="sid" value="">  <input id="lsname" type="text" value="" size="2" maxlenght="2"> <input id="lid" name="lid" value="" hidden>  <input id="ltype" name="type" value="league" hidden>  <input type="submit" id="leaguesubmit" value=""></form></div><?php }	?>