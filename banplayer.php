<?phprequire_once 'db.php';@require_once 'security.php';$player = $_GET['add'];$league = $_GET['extra'];if (!is_numeric($player) || !is_numeric($league) || !$isadmin) {    exit('fail');}$stmt = $dbh->prepare("SELECT lname, banned, name FROM yleagues NATURAL JOIN yseasonplayers NATURAL JOIN yplayers WHERE pid=:player AND lid=:league");$stmt->bindParam(':player', $player);$stmt->bindParam(':league', $league);$stmt->execute();if ($stmt->rowCount() > 0) {	$result = $stmt->fetch();}?> for <?php echo htmlspecialchars($result['name']); ?> in <?php echo htmlspecialchars($result['lname']); ?>, currently <?php echo $result['banned'] ? 'true' : 'false'; ?><BR><?php$stmt = $dbh->prepare("UPDATE yseasonplayers set banned=:toggle::bool WHERE pid=:player AND lid=:league");$banning = $result['banned'] ? 0 : 1;//echo gettype($result['banned']);//echo $banning;$stmt->bindParam(':player', $player);$stmt->bindParam(':toggle', $banning);$stmt->bindParam(':league', $league);$stmt->execute();if ($stmt->rowCount() > 0) echo 'Successfully ';else echo 'Failed to ';echo ($result['banned']) ? 'unbanned' : 'banned'?><BR><?php$stmt = $dbh->prepare("UPDATE yseasongames AS y SET value=joint.value,updated=now() FROM    (SELECT sid,gid,sum(coef)*(1-sum(banned::int)*.2) AS value FROM yleagues NATURAL JOIN      yseasonplayers NATURAL JOIN ygames_players NATURAL JOIN yseasongames GROUP BY sid,gid)      AS joint WHERE y.sid=joint.sid AND y.gid=joint.gid AND y.gid IN (SELECT DISTINCT gid      FROM yleagues NATURAL JOIN yseasongames NATURAL JOIN ygames_players WHERE lid=:league AND	pid=:player)");  $stmt->bindParam(':player', $player);  $stmt->bindParam(':league', $league);  $stmt->execute();  echo $stmt->rowcount() . ' updated gamevalues<BR>';if ($banning) {  $stmt = $dbh->prepare("DELETE FROM yseasonscore WHERE pid=:player AND lid=:league");  $stmt->bindParam(':player', $player);  $stmt->bindParam(':league', $league);  $stmt->execute();  echo $stmt->rowCount() . ' scores removed<BR>';} else {//same code as in the cron '20140101'  $stmt = $dbh->prepare("INSERT INTO yseasonscore (lid,pid,scpoints,scgames,scfirst,scsecond,scthird,scfourth,scupdated)    (SELECT lid,pid, sum(real_points*value+padding) AS score,     count(real_points) AS numbergames,     sum((placement=1)::int) AS first,  sum((placement=2)::int) AS second,    sum((placement=3)::int) AS third,   sum((placement=4)::int) AS fourth, now()    FROM yleagues NATURAL JOIN yseasonplayers NATURAL JOIN ygames_players NATURAL JOIN yseasongames    WHERE (lid,pid) NOT IN (SELECT lid,pid FROM yseasonscore) AND NOT gbanned AND NOT banned    GROUP BY lid,pid)");  $stmt->execute();  echo $stmt->rowcount() . ' new entries<BR>';}  $stmt = $dbh->prepare("UPDATE yseasonscore AS y SET    (scpoints,scgames,scfirst,scsecond,scthird,scfourth,scupdated) =    (j.score,j.numbergames,j.first,j.second,j.third,j.fourth, now()) FROM      (SELECT lid,pid, sum(real_points*value+padding) AS score, 	count(real_points) AS numbergames, 	sum((placement=1)::int) AS first,  sum((placement=2)::int) AS second,	sum((placement=3)::int) AS third,   sum((placement=4)::int) AS fourth	  FROM yleagues NATURAL JOIN yseasonplayers NATURAL JOIN ygames_players NATURAL JOIN yseasongames	WHERE (lid,pid) IN (SELECT DISTINCT lid,pid FROM yseasonscore NATURAL JOIN yseasongames NATURAL JOIN ygames_players NATURAL JOIN yleagues WHERE scupdated < updated)	  AND NOT gbanned GROUP BY lid,pid) AS j WHERE y.lid=j.lid AND y.pid=j.pid");// forgot join yleagues to not updated (link sid and lid)  $stmt->execute();  echo $stmt->rowcount() . ' scores updated</p><P>Player details';@include 'showplayer.php';?>