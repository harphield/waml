<?phprequire_once 'db.php';$league = $_GET['league'];$season = $_GET['season']; if (!is_numeric($league) || !is_numeric($season)) {	echo 'lelelel';	die();}$stmt = $dbh->prepare('SELECT name FROM leagues WHERE id = :league');$stmt->bindParam(':league', $league);$stmt->execute();if ($stmt->rowCount() > 0) {	$lg = $stmt->fetch();	$league_name = $lg['name'];	// special for league N	if ($league == 4) {		$lg_where = '(pll.leagueid IS NULL OR pll.leagueid = :league)';	} else {		$lg_where = 'pll.leagueid = :league';	}		$stmt = $dbh->prepare('SELECT players.id AS pid, players.name, coef, padding, real_points, placement, gameid FROM games_players gp							JOIN games ON games.id = gameid							JOIN players ON players.id = gp.playerid AND players.id != 1							JOIN seasons_leagues sl ON seasonid = season AND sl.leagueid = :league							JOIN seasons ON seasons.id = season							LEFT JOIN (SELECT pl.playerid, pl.leagueid, MAX(pl.start) AS lstart FROM players_league pl GROUP BY pl.playerid) pll ON pll.playerid = gp.playerid AND pll.lstart < seasons.end							WHERE ' . $lg_where . ' AND season = :season');								$stmt->bindParam(':league', $league);	$stmt->bindParam(':season', $season);	try { 		$pranking = array();		$stmt->execute();				if ($stmt->rowCount() > 0) {			$ranking = array();			$gvstmt = $dbh->prepare('SELECT SUM(coef) AS gamevalue FROM games				JOIN games_players gp ON gameid = games.id				JOIN seasons ON seasons.id = season				LEFT JOIN (SELECT pl.playerid, pl.leagueid, MAX(pl.start) AS lstart FROM players_league pl GROUP BY pl.playerid) pll ON pll.playerid = gp.playerid AND pll.lstart < seasons.end				JOIN seasons_leagues sl ON seasonid = season AND sl.leagueid = IF(pll.leagueid IS NULL, 4, pll.leagueid)				WHERE gameid = :thisgame');			$gvstmt->bindParam(':thisgame', $gameid);							$nnstmt = $dbh->prepare('SELECT gameid FROM games_players WHERE playerid = 1 AND gameid = :gameid');			$nnstmt->bindParam(':gameid', $gameid);						foreach ($stmt as $game) {				$gameid = $game['gameid'];				// get NoNames								$nnstmt->execute();								$coef = 1 - ($nnstmt->rowCount() * 0.2);								// game value				$gvstmt->execute();								$gv = $gvstmt->fetch();				$gamevalue = $gv['gamevalue'];				if (!isset($ranking[$game['pid']])) {					$placements = array(						1 => 0,						2 => 0,						3 => 0,						4 => 0,						'avg' => 0					);						$placements[$game['placement']] = 1;					$placements['avg'] += $game['placement'];									$ranking[$game['pid']] = array(						'name' => $game['name'],						'games' => 1,						'placements' => $placements,						'real_points' => $game['real_points'],						'points' => ($game['real_points'] * $coef * $gamevalue) + $game['padding']					);					$pranking[$game['pid']] = $ranking[$game['pid']]['points'];				} else {					$ranking[$game['pid']]['real_points'] += $game['real_points'];					$ranking[$game['pid']]['games']++;					$ranking[$game['pid']]['placements'][$game['placement']]++;					$ranking[$game['pid']]['placements']['avg'] += $game['placement'];					$ranking[$game['pid']]['points'] += ($game['real_points'] * $coef * $gamevalue) + $game['padding'];					$pranking[$game['pid']] += ($game['real_points'] * $coef * $gamevalue) + $game['padding'];				}						}						arsort($pranking);							}	} catch (PDOException $e) {		print_r($e);	}}?><div style="overflow: hidden; margin-bottom: 10px;">	<div style="float: right;">	<label class="checkbox">		<input type="checkbox" id="only_ranked" /> Show only ranked	</label></div></div>					<table class="table table-striped table-condensed tablesorter">	<thead>	<tr>		<th>#</th>		<th>Player</th>		<th>Points</th>		<th>Games</th>		<th class="centered">League</th>		<th>PPG</th>		<th>1st%</th>		<th>2nd%</th>		<th>3rd%</th>		<th>4th%</th>		<th>Avg</th>	</tr>	</thead>	<tbody>	<?php 	$i = 1;	foreach ($pranking as $player => $points) {		?>		<tr>			<td><?php echo $i++; ?></td>			<td><?php echo htmlspecialchars($ranking[$player]['name']) . $stars; ?></td>			<td><?php echo $points; ?></td>			<td><?php echo $ranking[$player]['games']; ?></td>			<td class="league_<?php echo $league_name; ?>"><?php echo $league_name; ?></td>			<td><?php echo round($points / $ranking[$player]['games'], 2); ?></td>			<td><?php echo round($ranking[$player]['placements'][1] / ($ranking[$player]['games'] / 100), 2); ?></td>			<td><?php echo round($ranking[$player]['placements'][2] / ($ranking[$player]['games'] / 100), 2); ?></td>			<td><?php echo round($ranking[$player]['placements'][3] / ($ranking[$player]['games'] / 100), 2); ?></td>			<td><?php echo round($ranking[$player]['placements'][4] / ($ranking[$player]['games'] / 100), 2); ?></td>			<td><?php echo round($ranking[$player]['placements']['avg'] / $ranking[$player]['games'], 2); ?></td>		</tr>		<?php	}		?>		</tbody></table>